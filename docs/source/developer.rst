.. role:: py:class(xref)
.. role:: py:meth(xref)
.. role:: py:func(xref)
.. role:: py:attr(xref)
.. role:: py:mod(xref)

Developer Docs
==============

Profiling Model
---------------

To profile a JAX model, you can use the :py:mod:`jax.profiler` module. The following code snippet shows how to start a trace, run your model, and then stop the trace. This will generate a trace file in the specified directory, which can be visualized using tools like TensorBoard or Perfetto.

For more information about JAX profiling, refer to the official documentation: `https://docs.jax.dev/en/latest/profiling.html`_

.. _`https://docs.jax.dev/en/latest/profiling.html`: https://docs.jax.dev/en/latest/profiling.html

.. code-block:: python

   import jax.profiler

   # Start a trace and create a Perfetto trace file
   jax.profiler.start_trace("./tensorboard_logs", create_perfetto_trace=True)

   model = Model(
       # orography=realistic_boundaries.orog,
   )

   # Run the model
   predictions = model.run(
       save_interval=.5/24,
       total_time=1/24,
       # boundaries=realistic_boundaries,
   )

   # Ensure all computations are complete before stopping the trace
   jax.tree_util.tree_map(
       lambda x: x.block_until_ready() if hasattr(x, 'block_until_ready') else x,
       predictions
   )

   # Stop the trace
   jax.profiler.stop_trace()

You can visualize the generated trace file using **Perfetto**, a performance analysis tool for a variety of platforms. 
To use Perfetto, navigate to https://ui.perfetto.dev/ in your web browser. Then, click "Open trace file" and select the 
`.perfetto-trace` file generated by :py:func:`jax.profiler.start_trace`. This will display a detailed timeline of your 
model's execution, showing CPU and GPU activity, memory usage, and other performance metrics, which is useful for debugging performance bottlenecks.